<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerenciador de Mapas - Last Take Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/map_manager_enhanced.css') }}">
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

<input type="hidden" id="sessionId" value="{{ session_id }}">

<!-- Header -->
<header class="header">
    <div class="header-left">
        <button class="back-btn" onclick="window.location.href='/dashboard'">â† Voltar</button>
        <h1>ğŸ—ºï¸ Gerenciador de Mapas</h1>
    </div>
    <div class="header-actions">
        <button class="btn" onclick="window.toolsModule.copyShareLink()">ğŸ”— Copiar Link</button>
        <button class="btn btn-danger" onclick="window.toolsModule.clearAll()">ğŸ—‘ï¸ Limpar Tudo</button>
    </div>
</header>

<div class="main-layout">
    <!-- Sidebar Esquerda RetrÃ¡til -->
    <div class="tools-sidebar">
        <button class="sidebar-toggle" onclick="window.toolsModule.toggleSidebar()">â—€</button>
        
        <div class="sidebar-header">ğŸ› ï¸ Ferramentas</div>
        <div class="sidebar-content">
            <div class="tools-section">
                <h4>Modo de Trabalho</h4>
                <div class="tool-grid">
                    <button class="tool-btn active" onclick="window.toolsModule.setTool('select')">âœ‹ Selecionar</button>
                    <button class="tool-btn" onclick="window.toolsModule.setTool('pan')">ğŸ¤š Mover</button>
                    <button class="tool-btn" onclick="window.toolsModule.setTool('draw')">âœï¸ Desenhar</button>
                    <button class="tool-btn" onclick="window.toolsModule.setTool('erase')">ğŸ§¹ Apagar</button>
                </div>
            </div>
            
            <div class="tools-section">
                <h4>Grid</h4>
                <div class="grid-controls">
                    <div class="control-row">
                        <label>
                            <input type="checkbox" checked onchange="window.canvasModule.toggleGrid()">
                            Mostrar Grid
                        </label>
                    </div>
                    <div class="control-row">
                        <label>Tamanho:</label>
                        <input type="range" min="20" max="100" value="50" step="5" onchange="window.canvasModule.updateGridSize(this.value)">
                        <span class="grid-size-value" id="gridSizeValue">50px</span>
                    </div>
                </div>
            </div>
            
            <div class="tools-section">
                <h4>Desenho</h4>
                <div class="grid-controls">
                    <div class="control-row">
                        <label>Tamanho:</label>
                        <input type="range" min="1" max="20" value="3" onchange="window.toolsModule.setBrushSize(this.value)">
                    </div>
                </div>
                <div class="color-palette" style="margin-top: 10px;">
                    <div class="color-option active" style="background: #9b59b6;" onclick="window.toolsModule.setDrawingColor('#9b59b6')"></div>
                    <div class="color-option" style="background: #e74c3c;" onclick="window.toolsModule.setDrawingColor('#e74c3c')"></div>
                    <div class="color-option" style="background: #3498db;" onclick="window.toolsModule.setDrawingColor('#3498db')"></div>
                    <div class="color-option" style="background: #2ecc71;" onclick="window.toolsModule.setDrawingColor('#2ecc71')"></div>
                    <div class="color-option" style="background: #f39c12;" onclick="window.toolsModule.setDrawingColor('#f39c12')"></div>
                    <div class="color-option" style="background: #1abc9c;" onclick="window.toolsModule.setDrawingColor('#1abc9c')"></div>
                    <div class="color-option" style="background: #e67e22;" onclick="window.toolsModule.setDrawingColor('#e67e22')"></div>
                    <div class="color-option" style="background: #ecf0f1;" onclick="window.toolsModule.setDrawingColor('#ecf0f1')"></div>
                    <div class="color-option" style="background: #34495e;" onclick="window.toolsModule.setDrawingColor('#34495e')"></div>
                    <div class="color-option" style="background: #000000;" onclick="window.toolsModule.setDrawingColor('#000000')"></div>
                </div>
                <button class="action-btn" onclick="window.toolsModule.clearDrawings()" style="margin-top: 10px;">ğŸ§¹ Limpar Desenhos</button>
            </div>
            
            <div class="tools-section">
                <h4>Adicionar ao Mapa</h4>
                <button class="action-btn" onclick="window.itemsModule.addImage()">ğŸ–¼ï¸ Adicionar Imagem</button>
                <button class="action-btn" onclick="window.itemsModule.addToken()">ğŸ­ Adicionar Token</button>
            </div>
            
            <div class="tools-section">
                <h4>Imagens no Mapa</h4>
                <div class="item-list" id="imageList">
                    <div class="empty-state">Nenhuma imagem</div>
                </div>
            </div>
            
            <div class="tools-section">
                <h4>Tokens no Mapa</h4>
                <div class="item-list" id="tokenList">
                    <div class="empty-state">Nenhum token</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Canvas Container -->
    <div class="canvas-container">
        <div class="canvas-wrapper" id="canvasWrapper">
            <canvas id="mapCanvas"></canvas>
            <canvas id="drawingCanvas"></canvas>
            <canvas id="gridCanvas"></canvas>
        </div>
    </div>
</div>

<!-- BotÃµes Flutuantes -->
<div class="floating-buttons">
    <button class="floating-btn" onclick="window.playersModule.togglePlayersPanel()" title="Jogadores">ğŸ‘¥</button>
    <button class="floating-btn" onclick="window.playersModule.toggleDiceRoller()" title="Dados">ğŸ²</button>
</div>

<!-- Painel de Jogadores -->
<div class="floating-panel" id="playersPanel">
    <div class="panel-header">
        <h3>ğŸ‘¥ Jogadores</h3>
        <button class="panel-close" onclick="window.playersModule.togglePlayersPanel()">Ã—</button>
    </div>
    <div class="panel-content">
        <div class="players-list" id="playersList">
            <div class="empty-state">Nenhum jogador</div>
        </div>
    </div>
</div>

<!-- Painel de Dados -->
<div class="floating-panel" id="dicePanel">
    <div class="panel-header">
        <h3>ğŸ² Dados</h3>
        <button class="panel-close" onclick="window.playersModule.toggleDiceRoller()">Ã—</button>
    </div>
    <div class="panel-content">
        <div class="dice-result" id="diceResult">Selecione um dado</div>
        <div class="dice-grid">
            <button class="dice-btn" onclick="window.playersModule.rollDice(4)">d4</button>
            <button class="dice-btn" onclick="window.playersModule.rollDice(6)">d6</button>
            <button class="dice-btn" onclick="window.playersModule.rollDice(8)">d8</button>
            <button class="dice-btn" onclick="window.playersModule.rollDice(10)">d10</button>
            <button class="dice-btn" onclick="window.playersModule.rollDice(12)">d12</button>
            <button class="dice-btn" onclick="window.playersModule.rollDice(20)">d20</button>
            <button class="dice-btn" onclick="window.playersModule.rollDice(100)">d100</button>
        </div>
    </div>
</div>

<!-- Chat Container WhatsApp -->
<div class="chat-container" id="chatContainer">
    <div class="chat-header" onclick="window.chatModule.toggleChatMinimize()">
        <div class="chat-header-left">
            <h3>ğŸ’¬ Chat</h3>
            <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
        </div>
        <div class="chat-controls">
            <button class="chat-control-btn" onclick="event.stopPropagation(); window.chatModule.toggleChatMinimize()">
                <span id="chatMinimizeIcon">â–¼</span>
            </button>
            <button class="chat-control-btn" onclick="event.stopPropagation(); window.chatModule.toggleChatCollapse()">Ã—</button>
        </div>
    </div>
    
    <div class="chat-body">
        <div class="chat-contacts" id="chatContacts">
            <div id="contactsList"></div>
        </div>
        
        <div class="chat-conversation">
            <div class="conversation-placeholder" id="conversationPlaceholder">
                <div class="conversation-placeholder-icon">ğŸ’¬</div>
                <p>Selecione um jogador</p>
            </div>
            
            <div id="conversationArea" style="display: none;">
                <div class="conversation-header">
                    <div class="contact-avatar" id="conversationContactAvatar">?</div>
                    <div class="conversation-info">
                        <h4 id="conversationContactName">Jogador</h4>
                    </div>
                </div>
                
                <div class="conversation-messages" id="conversationMessages"></div>
                
                <div class="conversation-input-area">
                    <input type="text" 
                           class="conversation-input" 
                           id="conversationInput" 
                           placeholder="Mensagem..." 
                           maxlength="500">
                    <button class="conversation-send-btn" onclick="window.chatModule.sendChatMessage()">â¤</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Token -->
<div class="modal" id="tokenModal">
    <div class="modal-content">
        <h3>Adicionar Token</h3>
        
        <div class="control-group">
            <label>Nome</label>
            <input type="text" id="tokenName" placeholder="Ex: Guerreiro">
        </div>
        
        <div class="control-group">
            <label>Estilo do Token</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="styleRound" name="tokenStyle" value="round" checked>
                    <label for="styleRound">ğŸ”µ Redondo</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="styleSquare" name="tokenStyle" value="square">
                    <label for="styleSquare">â¬œ Quadrado</label>
                </div>
            </div>
        </div>
        
        <div class="control-group">
            <label>Imagem (opcional)</label>
            <input type="file" id="tokenImage" accept="image/*">
        </div>
        
        <div class="modal-actions">
            <button class="btn" onclick="window.itemsModule.closeTokenModal()">Cancelar</button>
            <button class="action-btn" onclick="window.itemsModule.createToken()">Criar Token</button>
        </div>
    </div>
</div>

<!-- Modal de PermissÃµes -->
<div class="modal" id="tokenPermissionsModal">
    <div class="modal-content" style="max-width: 600px;">
        <h3 id="tokenPermModalTitle">PermissÃµes de Tokens</h3>
        <input type="hidden" id="currentPlayerId">
        
        <p style="color: #bbb; margin-bottom: 15px;">
            Selecione quais tokens este jogador pode mover:
        </p>
        
        <div class="item-list" id="tokenPermList" style="max-height: 400px;"></div>
        
        <div class="modal-actions">
            <button class="action-btn" onclick="window.playersModule.closeTokenPermissionsModal()">Fechar</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<!-- Scripts Modularizados -->
<script src="{{ url_for('static', filename='js/map_socket.js') }}"></script>
<script src="{{ url_for('static', filename='js/map_canvas.js') }}"></script>
<script src="{{ url_for('static', filename='js/map_tools.js') }}"></script>
<script src="{{ url_for('static', filename='js/map_mouse.js') }}"></script>
<script src="{{ url_for('static', filename='js/map_items.js') }}"></script>
<script src="{{ url_for('static', filename='js/map_chat.js') }}"></script>
<script src="{{ url_for('static', filename='js/map_players_dice.js') }}"></script>

</body>
</html>