<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerenciador de Mapas - Last Take Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/map_manager_enhanced.css') }}">
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

<input type="hidden" id="sessionId" value="{{ session_id }}">

<!-- Header -->
<header class="header">
    <div class="header-left">
        <button class="back-btn" onclick="window.location.href='/dashboard'">â† Voltar</button>
        <h1>ğŸ—ºï¸ Gerenciador de Mapas</h1>
    </div>
    <div class="header-actions">
        <button class="btn" onclick="copyShareLink()">ğŸ”— Copiar Link</button>
        <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ Limpar Tudo</button>
    </div>
</header>
<div class="main-layout">
    <div class="tools-sidebar">
        <div class="sidebar-header">ğŸ› ï¸ Ferramentas</div>
        <div class="sidebar-content">
            <div class="tools-section">
                <h4>Modo de Trabalho</h4>
                <div class="tool-grid">
                    <button class="tool-btn active" onclick="setTool('select')">âœ‹ Selecionar</button>
                    <button class="tool-btn" onclick="setTool('pan')">ğŸ¤š Mover</button>
                    <button class="tool-btn" onclick="setTool('draw')">âœï¸ Desenhar</button>
                    <button class="tool-btn" onclick="setTool('erase')">ğŸ§¹ Apagar</button>
                </div>
            </div>
            <div class="tools-section">
                <h4>Grid</h4>
                <div class="grid-controls">
                    <div class="control-row">
                        <label>
                            <input type="checkbox" checked onchange="toggleGrid()">
                            Mostrar Grid
                        </label>
                    </div>
                    <div class="control-row">
                        <label>Tamanho:</label>
                        <input type="range" min="20" max="100" value="50" step="5" onchange="updateGridSize(this.value)">
                        <span class="grid-size-value" id="gridSizeValue">50px</span>
                    </div>
                </div>
            </div>
            <div class="tools-section">
                <h4>Desenho</h4>
                <div class="grid-controls">
                    <div class="control-row">
                        <label>Tamanho:</label>
                        <input type="range" min="1" max="20" value="3" onchange="setBrushSize(this.value)">
                    </div>
                </div>
                <div class="color-palette" style="margin-top: 10px;">
                    <div class="color-option active" style="background: #9b59b6;" onclick="setDrawingColor('#9b59b6')"></div>
                    <div class="color-option" style="background: #e74c3c;" onclick="setDrawingColor('#e74c3c')"></div>
                    <div class="color-option" style="background: #3498db;" onclick="setDrawingColor('#3498db')"></div>
                    <div class="color-option" style="background: #2ecc71;" onclick="setDrawingColor('#2ecc71')"></div>
                    <div class="color-option" style="background: #f39c12;" onclick="setDrawingColor('#f39c12')"></div>
                    <div class="color-option" style="background: #1abc9c;" onclick="setDrawingColor('#1abc9c')"></div>
                    <div class="color-option" style="background: #e67e22;" onclick="setDrawingColor('#e67e22')"></div>
                    <div class="color-option" style="background: #ecf0f1;" onclick="setDrawingColor('#ecf0f1')"></div>
                    <div class="color-option" style="background: #34495e;" onclick="setDrawingColor('#34495e')"></div>
                    <div class="color-option" style="background: #000000;" onclick="setDrawingColor('#000000')"></div>
                </div>
                <button class="action-btn" onclick="clearDrawings()" style="margin-top: 10px;">ğŸ§¹ Limpar Desenhos</button>
            </div>
            <div class="tools-section">
                <h4>Adicionar ao Mapa</h4>
                <button class="action-btn" onclick="addImage()">ğŸ–¼ï¸ Adicionar Imagem</button>
                <button class="action-btn" onclick="addToken()">ğŸ­ Adicionar Token</button>
            </div>
            <div class="tools-section">
                <h4>Imagens no Mapa</h4>
                <div class="item-list" id="imageList">
                    <div class="empty-state">Nenhuma imagem</div>
                </div>
            </div>
            <div class="tools-section">
                <h4>Tokens no Mapa</h4>
                <div class="item-list" id="tokenList">
                    <div class="empty-state">Nenhum token</div>
                </div>
            </div>
        </div>
    </div>
    <div class="canvas-container">
        <div class="canvas-wrapper" id="canvasWrapper">
            <canvas id="mapCanvas"></canvas>
            <canvas id="drawingCanvas"></canvas>
            <canvas id="gridCanvas"></canvas>
        </div>
    </div>
</div>
<div class="floating-buttons">
    <button class="floating-btn" onclick="togglePlayersPanel()" title="Jogadores">
        ğŸ‘¥
    </button>
    <button class="floating-btn" onclick="toggleDiceRoller()" title="Dados">
        ğŸ²
    </button>
</div>
<div class="floating-panel" id="playersPanel">
    <div class="panel-header">
        <h3>ğŸ‘¥ Jogadores</h3>
        <button class="panel-close" onclick="togglePlayersPanel()">Ã—</button>
    </div>
    <div class="panel-content">
        <div class="players-list" id="playersList">
            <div class="empty-state">Nenhum jogador</div>
        </div>
    </div>
</div>
<div class="floating-panel" id="dicePanel">
    <div class="panel-header">
        <h3>ğŸ² Dados</h3>
        <button class="panel-close" onclick="toggleDiceRoller()">Ã—</button>
    </div>
    <div class="panel-content">
        <div class="dice-result" id="diceResult">Selecione um dado</div>
        
        <div class="dice-grid">
            <button class="dice-btn" onclick="rollDice(4)">d4</button>
            <button class="dice-btn" onclick="rollDice(6)">d6</button>
            <button class="dice-btn" onclick="rollDice(8)">d8</button>
            <button class="dice-btn" onclick="rollDice(10)">d10</button>
            <button class="dice-btn" onclick="rollDice(12)">d12</button>
            <button class="dice-btn" onclick="rollDice(20)">d20</button>
            <button class="dice-btn" onclick="rollDice(100)">d100</button>
        </div>
    </div>
</div>
<div class="chat-bottom minimized" id="chatBottom">
    <div class="chat-toggle" onclick="toggleChat()">
        <h3>ğŸ’¬ Mensagens</h3>
        <span class="chat-arrow">â–²</span>
    </div>
    
    <div class="chat-main-content">
        <div class="chat-layout">
            <div class="chat-contacts">
                <div class="contacts-header">
                    ğŸ’¬ Conversas
                </div>
                <div class="contacts-list" id="contactsList">
                    <div class="empty-state">Nenhum jogador conectado</div>
                </div>
            </div>
            <div class="chat-conversation">
                <div class="conversation-placeholder" id="conversationPlaceholder">
                    <div class="conversation-placeholder-icon">ğŸ’¬</div>
                    <p>Selecione um jogador para iniciar uma conversa</p>
                </div>
                <div id="conversationArea" style="display: none; flex-direction: column; height: 100%;">
                    <div class="conversation-header">
                        <div class="contact-avatar" id="conversationContactAvatar">?</div>
                        <div class="conversation-header-info">
                            <h4 id="conversationContactName">Jogador</h4>
                            <p>Online</p>
                        </div>
                    </div>
                    
                    <div class="conversation-messages" id="conversationMessages">
                    </div>
                    
                    <div class="conversation-input-area">
                        <input type="text" 
                               class="conversation-input" 
                               id="conversationInput" 
                               placeholder="Digite uma mensagem..." 
                               maxlength="500">
                        <button class="conversation-send-btn" onclick="sendChatMessage()">
                            â¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Token -->
<div class="modal" id="tokenModal">
    <div class="modal-content">
        <h3>Adicionar Token</h3>
        
        <div class="control-group">
            <label>Nome</label>
            <input type="text" id="tokenName" placeholder="Ex: Guerreiro">
        </div>
        
        <div class="control-group">
            <label>Estilo do Token</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="styleRound" name="tokenStyle" value="round" checked>
                    <label for="styleRound">ğŸ”µ Redondo (com borda circular)</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="styleSquare" name="tokenStyle" value="square">
                    <label for="styleSquare">â¬œ Quadrado (imagem completa)</label>
                </div>
            </div>
        </div>
        
        <div class="control-group">
            <label>Imagem (opcional)</label>
            <input type="file" id="tokenImage" accept="image/*">
            <small style="color: #888; display: block; margin-top: 5px;">
                Se nÃ£o selecionar uma imagem, serÃ¡ criado um token colorido
            </small>
        </div>
        
        <div class="modal-actions">
            <button class="btn" onclick="closeTokenModal()">Cancelar</button>
            <button class="action-btn" onclick="createToken()">Criar Token</button>
        </div>
    </div>
</div>

<div class="modal" id="tokenPermissionsModal">
    <div class="modal-content" style="max-width: 600px;">
        <h3 id="tokenPermModalTitle">PermissÃµes de Tokens</h3>
        <input type="hidden" id="currentPlayerId">
        
        <p style="color: #bbb; margin-bottom: 15px;">
            Selecione quais tokens este jogador pode mover:
        </p>
        
        <div class="item-list" id="tokenPermList" style="max-height: 400px;"></div>
        
        <div class="modal-actions">
            <button class="action-btn" onclick="closeTokenPermissionsModal()">Fechar</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script defer src="{{ url_for('static', filename='js/map_manager_enhanced.js') }}"></script>

</body>
</html>