<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerenciador de Mapas - Last Take Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/map_manager_enhanced.css') }}">
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

<input type="hidden" id="sessionId" value="{{ session_id }}">

<!-- Header -->
<header class="header">
    <div class="header-left">
        <button class="back-btn" onclick="window.location.href='/dashboard'">â† Voltar</button>
        <h1>ğŸ—ºï¸ Gerenciador de Mapas</h1>
    </div>
    <div class="header-actions">
        <button class="btn" onclick="openSceneManager()">ğŸ¬ Cenas</button>
        <button class="btn" onclick="copyShareLink()">ğŸ”— Copiar Link</button>
        <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ Limpar Tudo</button>
        <div style="display: flex; gap: 5px; align-items: center;">
            <button class="btn" onclick="zoom(-0.1)" title="Zoom Out">ğŸ”âˆ’</button>
            <span style="color: #fff; font-size: 0.9rem; min-width: 50px; text-align: center;" id="zoomLevel">50%</span>
            <button class="btn" onclick="zoom(0.1)" title="Zoom In">ğŸ”+</button>
            <button class="btn" onclick="currentScale = 1; applyTransform(); document.getElementById('zoomLevel').textContent = '100%';" title="Reset Zoom">â†º</button>
        </div>
    </div>
</header>
<div id="panIndicator" style="
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, rgba(155,89,182,0.95), rgba(108,52,131,0.95));
    color: #fff;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    z-index: 1000;
    box-shadow: 0 4px 15px rgba(155,89,182,0.5);
    display: none;
    align-items: center;
    gap: 8px;
    border: 2px solid rgba(255,255,255,0.2);
">
    <span>ğŸ¤š</span>
    <span>Segure ESPAÃ‡O para mover o mapa</span>
</div>
<div class="main-layout">
    <!-- Sidebar Esquerda RetrÃ¡til -->
    <div class="tools-sidebar">
        <button class="sidebar-toggle" onclick="toggleSidebar()">â—€</button>
        
        <div class="sidebar-header">ğŸ› ï¸ Ferramentas</div>
        <div class="sidebar-content">
            <div class="tools-section">
                <h4>ğŸ¯ Modo de Trabalho</h4>
                <div class="tool-grid">
                    <button class="tool-btn active" onclick="setTool('select')">âœ‹ Selecionar</button>
                    <button class="tool-btn" onclick="setTool('pan')">ğŸ¤š Mover</button>
                    <button class="tool-btn" onclick="setTool('draw')">âœï¸ Desenhar</button>
                    <button class="tool-btn" onclick="setTool('erase')">ğŸ§¹ Apagar</button>
                </div>
            </div>
            
            <div class="tools-section">
                <h4>ğŸ“ Grid do Mapa</h4>
                <div class="grid-controls">
                    <div class="control-row">
                        <label>
                            <input type="checkbox" checked onchange="toggleGrid()">
                            Exibir Grid
                        </label>
                    </div>
                    <div class="control-row">
                        <label>Tamanho da CÃ©lula</label>
                        <input type="range" min="20" max="100" value="50" step="5" onchange="updateGridSize(this.value)">
                        <span class="grid-size-value" id="gridSizeValue">50px</span>
                    </div>
                </div>
            </div>
            
            <div class="tools-section">
                <h4>ğŸ¨ Ferramentas de Desenho</h4>
                <div class="grid-controls">
                    <div class="control-row">
                        <label>Espessura do Pincel</label>
                        <input type="range" min="1" max="20" value="3" onchange="setBrushSize(this.value)">
                    </div>
                </div>
                <div class="color-palette" style="margin-top: 12px;">
                    <div class="color-option active" style="background: #9b59b6;" onclick="setDrawingColor('#9b59b6')"></div>
                    <div class="color-option" style="background: #e74c3c;" onclick="setDrawingColor('#e74c3c')"></div>
                    <div class="color-option" style="background: #3498db;" onclick="setDrawingColor('#3498db')"></div>
                    <div class="color-option" style="background: #2ecc71;" onclick="setDrawingColor('#2ecc71')"></div>
                    <div class="color-option" style="background: #f39c12;" onclick="setDrawingColor('#f39c12')"></div>
                    <div class="color-option" style="background: #1abc9c;" onclick="setDrawingColor('#1abc9c')"></div>
                    <div class="color-option" style="background: #e67e22;" onclick="setDrawingColor('#e67e22')"></div>
                    <div class="color-option" style="background: #ecf0f1;" onclick="setDrawingColor('#ecf0f1')"></div>
                    <div class="color-option" style="background: #34495e;" onclick="setDrawingColor('#34495e')"></div>
                    <div class="color-option" style="background: #000000;" onclick="setDrawingColor('#000000')"></div>
                </div>
                <button class="action-btn" onclick="clearDrawings()" style="margin-top: 12px;">ğŸ§¹ Limpar Todos os Desenhos</button>
            </div>
            
            <div class="tools-section">
                <h4>â• Adicionar Elementos</h4>
                <button class="action-btn" onclick="addImage()">ğŸ–¼ï¸ Adicionar Imagem</button>
                <button class="action-btn" onclick="addToken()">ğŸ­ Adicionar Token</button>
            </div>
            
            <div class="tools-section">
                <h4>ğŸ–¼ï¸ Imagens no Mapa</h4>
                <div class="item-list" id="imageList">
                    <div class="empty-state">Nenhuma imagem adicionada</div>
                </div>
            </div>
            
            <div class="tools-section">
                <h4>ğŸ­ Tokens Ativos</h4>
                <div class="item-list" id="tokenList">
                    <div class="empty-state">Nenhum token no mapa</div>
                </div>
            </div>
            <div class="tools-section">
                <h4>ğŸŒ«ï¸ NÃ©voa</h4>
                
                <div id="fogModeIndicator" class="fog-mode-indicator" style="display: none;">
                    ğŸŒ«ï¸ Desenhando NÃ©voa
                </div>
                
                <button class="action-btn" onclick="toggleFogMode()">
                    ğŸŒ«ï¸ Ativar/Desativar Modo NÃ©voa
                </button>
                
                <div style="margin-top: 12px;">
                    <h4 style="color: #c49bdb; font-size: 0.85rem; margin-bottom: 8px;">Forma da Ãrea</h4>
                    <div class="fog-shape-selector">
                        <button class="tool-btn active" onclick="setFogShape('rectangle')">â¬œ</button>
                        <button class="tool-btn" onclick="setFogShape('circle')">ğŸ”µ</button>
                    </div>
                </div>
                
                <div class="control-row" style="margin-top: 12px;">
                    <label>Opacidade (Visual do Mestre)</label>
                    <input type="range" min="0.1" max="1" value="0.5" step="0.05" onchange="setFogOpacity(this.value)">
                    <span class="grid-size-value" id="fogOpacityValue">50%</span>
                </div>
                
                <button class="action-btn" onclick="clearAllFog()" style="margin-top: 12px; background: linear-gradient(135deg, #3498db, #2980b9);">
                    âœ¨ Limpar NÃ©voa
                </button>
                
                <h4 style="color: #c49bdb; font-size: 0.85rem; margin: 15px 0 8px 0;">Ãreas Reveladas</h4>
                <div class="item-list" id="fogAreasList">
                    <div class="empty-state">Nenhuma Ã¡rea revelada</div>
                </div>
                
                <div class="fog-preview">
                    ğŸ’¡ Desenhe no mapa para criar Ã¡reas visÃ­veis
                </div>
            </div>
        </div>
    </div>
    
    <!-- Canvas Container -->
    <div class="canvas-container">
        <div class="canvas-wrapper" id="canvasWrapper">
            <canvas id="mapCanvas"></canvas>
            <canvas id="drawingCanvas"></canvas>
            <canvas id="gridCanvas"></canvas>
            <canvas id="fogCanvas"></canvas>
        </div>
    </div>
</div>

<!-- BotÃµes Flutuantes -->
<div class="floating-buttons">
    <button class="floating-btn" onclick="togglePlayersPanel()" title="Jogadores">ğŸ‘¥</button>
    <button class="floating-btn" onclick="toggleDiceRoller()" title="Dados">ğŸ²</button>
</div>

<!-- Painel de Jogadores -->
<div class="floating-panel" id="playersPanel">
    <div class="panel-header">
        <h3>ğŸ‘¥ Jogadores</h3>
        <button class="panel-close" onclick="togglePlayersPanel()">Ã—</button>
    </div>
    <div class="panel-content">
        <div class="players-list" id="playersList">
            <div class="empty-state">Nenhum jogador</div>
        </div>
    </div>
</div>

<!-- Painel de Dados -->
<div class="floating-panel" id="dicePanel">
    <div class="panel-header">
        <h3>ğŸ² Rolador de Dados</h3>
        <button class="panel-close" onclick="toggleDiceRoller()">Ã—</button>
    </div>
    <div class="panel-content">
        <!-- Resultado -->
        <div class="dice-result" id="diceResult">Selecione um dado</div>
        
        <!-- Dados RÃ¡pidos -->
        <div style="margin-bottom: 20px;">
            <h4 style="color: #c49bdb; margin-bottom: 10px; font-size: 0.95rem;">âš¡ Dados RÃ¡pidos</h4>
            <div class="dice-grid">
                <button class="dice-btn" onclick="rollDice(4)">d4</button>
                <button class="dice-btn" onclick="rollDice(6)">d6</button>
                <button class="dice-btn" onclick="rollDice(8)">d8</button>
                <button class="dice-btn" onclick="rollDice(10)">d10</button>
                <button class="dice-btn" onclick="rollDice(12)">d12</button>
                <button class="dice-btn" onclick="rollDice(20)">d20</button>
                <button class="dice-btn" onclick="rollDice(100)">d100</button>
            </div>
        </div>
        
        <!-- Rolagem Customizada -->
        <div style="background: rgba(16,16,30,0.6); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #c49bdb; margin-bottom: 12px; font-size: 0.95rem;">ğŸ¯ Rolagem Personalizada</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <div>
                    <label style="color: #bbb; font-size: 0.8rem; display: block; margin-bottom: 5px;">Quantidade</label>
                    <input type="number" id="customDiceCount" value="1" min="1" max="20" 
                           style="width: 100%; padding: 8px; background: rgba(0,0,0,0.4); border: 1px solid rgba(155,89,182,0.3); color: #fff; border-radius: 6px;">
                </div>
                <div>
                    <label style="color: #bbb; font-size: 0.8rem; display: block; margin-bottom: 5px;">Tipo</label>
                    <select id="customDiceSides" 
                            style="width: 100%; padding: 8px; background: rgba(0,0,0,0.4); border: 1px solid rgba(155,89,182,0.3); color: #fff; border-radius: 6px;">
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10">d10</option>
                        <option value="12">d12</option>
                        <option value="20" selected>d20</option>
                        <option value="100">d100</option>
                    </select>
                </div>
                <div>
                    <label style="color: #bbb; font-size: 0.8rem; display: block; margin-bottom: 5px;">Modificador</label>
                    <input type="number" id="customDiceModifier" value="0" min="-100" max="100" 
                           style="width: 100%; padding: 8px; background: rgba(0,0,0,0.4); border: 1px solid rgba(155,89,182,0.3); color: #fff; border-radius: 6px;">
                </div>
            </div>
            <button class="action-btn" onclick="rollCustomDice()" style="width: 100%;">ğŸ² Rolar</button>
        </div>
        
        <!-- HistÃ³rico -->
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="color: #c49bdb; font-size: 0.95rem; margin: 0;">ğŸ“‹ HistÃ³rico</h4>
                <button onclick="clearDiceHistory()" 
                        style="padding: 4px 10px; background: rgba(231,76,60,0.2); border: 1px solid #e74c3c; color: #fff; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                    ğŸ—‘ï¸ Limpar
                </button>
            </div>
            <div id="diceHistoryList" style="max-height: 200px; overflow-y: auto;">
                <div class="empty-state" style="padding: 20px; color: #666; text-align: center;">Nenhuma rolagem ainda</div>
            </div>
        </div>
    </div>
</div>

<div class="chat-container" id="chatContainer">
    <div class="chat-header" onclick="toggleChatMinimize()">
        <div class="chat-header-left">
            <h3>ğŸ’¬ Chat</h3>
            <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
        </div>
        <div class="chat-controls">
            <button class="chat-control-btn" onclick="event.stopPropagation(); toggleChatMinimize()">
                <span id="chatMinimizeIcon">â–¼</span>
            </button>
        </div>
    </div>
    
    <div class="chat-body">
        <!-- Lista de Contatos -->
        <div class="chat-contacts">
            <div id="contactsList">
                <div class="empty-state">Nenhum contato</div>
            </div>
        </div>
        
        <!-- Ãrea de Conversa -->
        <div class="chat-conversation">
            <!-- Placeholder -->
            <div class="conversation-placeholder" id="conversationPlaceholder">
                <div class="conversation-placeholder-icon">ğŸ’¬</div>
                <p>Selecione um contato para iniciar</p>
            </div>
            
            <!-- Conversa Ativa -->
            <div id="conversationArea" style="display: none; flex-direction: column; height: 100%;">
                <div class="conversation-header">
                    <div class="contact-avatar" id="conversationContactAvatar">?</div>
                    <div class="conversation-info">
                        <h4 id="conversationContactName">Contato</h4>
                    </div>
                </div>
                
                <div class="conversation-messages" id="conversationMessages"></div>
                
                <div class="conversation-input-area">
                    <input type="text" 
                           class="conversation-input" 
                           id="conversationInput" 
                           placeholder="Digite sua mensagem..." 
                           maxlength="500">
                    <button class="conversation-send-btn" onclick="sendChatMessage()">â¤</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Token -->
<div class="modal" id="tokenModal">
    <div class="modal-content">
        <h3>Adicionar Token</h3>
        
        <div class="control-group">
            <label>Nome</label>
            <input type="text" id="tokenName" placeholder="Ex: Guerreiro">
        </div>
        
        <div class="control-group">
            <label>Estilo do Token</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="styleRound" name="tokenStyle" value="round" checked>
                    <label for="styleRound">ğŸ”µ Redondo</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="styleSquare" name="tokenStyle" value="square">
                    <label for="styleSquare">â¬œ Quadrado</label>
                </div>
            </div>
        </div>
        
        <div class="control-group">
            <label>Imagem (opcional)</label>
            <input type="file" id="tokenImage" accept="image/*">
        </div>
        
        <div class="modal-actions">
            <button class="btn" onclick="closeTokenModal()">Cancelar</button>
            <button class="action-btn" onclick="createToken()">Criar Token</button>
        </div>
    </div>
</div>

<!-- Modal de PermissÃµes de Tokens -->
<div class="modal" id="tokenPermissionsModal">
    <div class="modal-content" style="max-width: 600px;">
        <h3 id="tokenPermModalTitle">PermissÃµes de Tokens</h3>
        <input type="hidden" id="currentPlayerId">
        
        <p style="color: #bbb; margin-bottom: 15px;">
            Selecione quais tokens este jogador pode mover:
        </p>
        
        <div class="item-list" id="tokenPermList" style="max-height: 400px;"></div>
        
        <div class="modal-actions">
            <button class="action-btn" onclick="closeTokenPermissionsModal()">Fechar</button>
        </div>
    </div>
</div>
<!-- Modal de Gerenciador de Cenas -->
<div class="modal" id="sceneManagerModal">
    <div class="modal-content" style="max-width: 800px;">
        <h3>ğŸ¬ Gerenciador de Cenas</h3>
        
        <button class="action-btn" onclick="createNewScene()" style="margin-bottom: 20px;">
            + Criar Nova Cena
        </button>
        
        <div class="item-list" id="scenesList" style="max-height: 500px;">
            <div class="empty-state">Nenhuma cena criada</div>
        </div>
        
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="btn" onclick="closeSceneManager()">Fechar</button>
        </div>
    </div>
</div>

<!-- Modal de Visibilidade de Cena -->
<div class="modal" id="sceneVisibilityModal">
    <div class="modal-content" style="max-width: 600px;">
        <h3 id="sceneVisibilityTitle">ğŸ‘ï¸ Visibilidade da Cena</h3>
        <input type="hidden" id="currentSceneIdForVisibility">
        
        <p style="color: #bbb; margin-bottom: 15px; font-size: 0.95rem;">
            âœ… = Jogador pode ver esta cena<br>
            âŒ = Cena oculta para o jogador
        </p>
        
        <div class="item-list" id="sceneVisibilityList" style="max-height: 400px;"></div>
        
        <div class="modal-actions">
            <button class="action-btn" onclick="closeSceneVisibilityModal()">âœ”ï¸ Fechar</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script defer src="{{ url_for('static', filename='js/map_manager_enhanced.js') }}"></script>
<script defer src="{{ url_for('static', filename='js/scene_manager.js') }}"></script>

</body>
</html>