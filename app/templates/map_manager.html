<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerenciador de Mapas - Last Take Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/map_manager_enhanced.css') }}">
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

<input type="hidden" id="sessionId" value="{{ session_id }}">

<!-- Header Compacto -->
<header class="header">
    <div class="header-left">
        <button class="back-btn" onclick="window.location.href='/dashboard'">â† Voltar</button>
        <h1>ğŸ—ºï¸ Gerenciador de Mapas</h1>
    </div>
    <div class="header-actions">
        <button class="btn" onclick="copyShareLink()">ğŸ”— Copiar Link</button>
        <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ Limpar Tudo</button>
    </div>
</header>

<!-- Canvas Fullscreen -->
<div class="canvas-container">
    <canvas id="gridCanvas"></canvas>
    <canvas id="mapCanvas"></canvas>
    <canvas id="drawingCanvas"></canvas>
    
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoom(-0.1)">âˆ’</button>
        <button class="zoom-btn" onclick="zoom(0.1)">+</button>
    </div>
</div>

<!-- BotÃµes Flutuantes -->
<div class="floating-buttons">
    <button class="floating-btn" onclick="toggleToolsPanel()" title="Ferramentas">
        ğŸ› ï¸
    </button>
    <button class="floating-btn" onclick="togglePlayersPanel()" title="Jogadores">
        ğŸ‘¥
    </button>
    <button class="floating-btn" onclick="toggleChatPanel()" title="Chat">
        ğŸ’¬
    </button>
    <button class="floating-btn" onclick="toggleDiceRoller()" title="Dados">
        ğŸ²
    </button>
</div>

<!-- Painel de Ferramentas -->
<div class="floating-panel" id="toolsPanel">
    <div class="panel-header">
        <h3>ğŸ› ï¸ Ferramentas</h3>
        <button class="panel-close" onclick="toggleToolsPanel()">Ã—</button>
    </div>
    <div class="panel-content">
        <!-- Ferramentas de SeleÃ§Ã£o -->
        <div class="tools-section">
            <h4>Modo de Trabalho</h4>
            <div class="tool-grid">
                <button class="tool-btn active" onclick="setTool('select')">âœ‹ Selecionar</button>
                <button class="tool-btn" onclick="setTool('pan')">ğŸ¤š Mover Canvas</button>
                <button class="tool-btn" onclick="setTool('draw')">âœï¸ Desenhar</button>
                <button class="tool-btn" onclick="setTool('erase')">ğŸ§¹ Apagar</button>
            </div>
        </div>

        <!-- Grid Settings -->
        <div class="tools-section">
            <h4>ConfiguraÃ§Ãµes da Grid</h4>
            <div class="grid-controls">
                <div class="control-row">
                    <label>
                        <input type="checkbox" checked onchange="toggleGrid()">
                        Mostrar Grid
                    </label>
                </div>
                <div class="control-row">
                    <label>Tamanho:</label>
                    <input type="range" min="20" max="100" value="50" step="5" onchange="updateGridSize(this.value)">
                    <span class="grid-size-value" id="gridSizeValue">50px</span>
                </div>
            </div>
        </div>

        <!-- Desenho -->
        <div class="tools-section">
            <h4>ConfiguraÃ§Ãµes de Desenho</h4>
            <div class="grid-controls">
                <div class="control-row">
                    <label>Tamanho:</label>
                    <input type="range" min="1" max="20" value="3" onchange="setBrushSize(this.value)">
                </div>
            </div>
            <div class="color-palette" style="margin-top: 10px;">
                <div class="color-option active" style="background: #9b59b6;" onclick="setDrawingColor('#9b59b6')"></div>
                <div class="color-option" style="background: #e74c3c;" onclick="setDrawingColor('#e74c3c')"></div>
                <div class="color-option" style="background: #3498db;" onclick="setDrawingColor('#3498db')"></div>
                <div class="color-option" style="background: #2ecc71;" onclick="setDrawingColor('#2ecc71')"></div>
                <div class="color-option" style="background: #f39c12;" onclick="setDrawingColor('#f39c12')"></div>
                <div class="color-option" style="background: #1abc9c;" onclick="setDrawingColor('#1abc9c')"></div>
                <div class="color-option" style="background: #e67e22;" onclick="setDrawingColor('#e67e22')"></div>
                <div class="color-option" style="background: #ecf0f1;" onclick="setDrawingColor('#ecf0f1')"></div>
                <div class="color-option" style="background: #34495e;" onclick="setDrawingColor('#34495e')"></div>
                <div class="color-option" style="background: #000000;" onclick="setDrawingColor('#000000')"></div>
            </div>
            <button class="action-btn" onclick="clearDrawings()" style="margin-top: 10px;">ğŸ§¹ Limpar Desenhos</button>
        </div>

        <!-- Adicionar Elementos -->
        <div class="tools-section">
            <h4>Adicionar ao Mapa</h4>
            <button class="action-btn" onclick="addMap()">ğŸ“ Adicionar Mapa</button>
            <button class="action-btn" onclick="addEntity()">ğŸ–¼ï¸ Adicionar Entidade</button>
            <button class="action-btn" onclick="addToken()">ğŸ­ Adicionar Token</button>
        </div>

        <!-- Tokens -->
        <div class="tools-section">
            <h4>Tokens no Mapa</h4>
            <div class="token-list" id="tokenList">
                <div class="empty-state">Nenhum token adicionado</div>
            </div>
        </div>
    </div>
</div>

<!-- Painel de Jogadores -->
<div class="floating-panel" id="playersPanel">
    <div class="panel-header">
        <h3>ğŸ‘¥ Jogadores Online</h3>
        <button class="panel-close" onclick="togglePlayersPanel()">Ã—</button>
    </div>
    <div class="panel-content">
        <div class="players-list" id="playersList">
            <div class="empty-players">Nenhum jogador conectado</div>
        </div>
    </div>
</div>

<!-- Painel de Chat -->
<div class="floating-panel" id="chatPanel">
    <div class="panel-header">
        <h3>ğŸ’¬ Chat (Mestre vÃª tudo)</h3>
        <button class="panel-close" onclick="toggleChatPanel()">Ã—</button>
    </div>
    <div class="panel-content">
        <div class="chat-messages" id="chatMessages">
            <div class="empty-state">Nenhuma mensagem ainda</div>
        </div>
        <div class="chat-input-area">
            <select class="chat-recipient-select" id="chatRecipient">
                <option value="all">ğŸ“¢ VisÃ­vel apenas para mim</option>
            </select>
            <div class="chat-input-row">
                <input type="text" class="chat-input" id="chatInput" placeholder="Digite sua mensagem..." maxlength="500">
                <button class="chat-send-btn" onclick="sendChatMessage()">Enviar</button>
            </div>
        </div>
    </div>
</div>

<!-- Painel de Dados -->
<div class="floating-panel" id="dicePanel">
    <div class="panel-header">
        <h3>ğŸ² Rolador de Dados</h3>
        <button class="panel-close" onclick="toggleDiceRoller()">Ã—</button>
    </div>
    <div class="panel-content">
        <div class="dice-result" id="diceResult">
            Selecione um dado
        </div>
        
        <div class="dice-grid">
            <button class="dice-btn" onclick="rollDice(4)">d4</button>
            <button class="dice-btn" onclick="rollDice(6)">d6</button>
            <button class="dice-btn" onclick="rollDice(8)">d8</button>
            <button class="dice-btn" onclick="rollDice(10)">d10</button>
            <button class="dice-btn" onclick="rollDice(12)">d12</button>
            <button class="dice-btn" onclick="rollDice(20)">d20</button>
            <button class="dice-btn" onclick="rollDice(100)">d100</button>
        </div>
        
        <div class="tools-section">
            <h4>Rolagem Personalizada</h4>
            <div class="custom-dice-form">
                <div class="form-row">
                    <input type="number" id="diceCount" placeholder="Qtd" value="1" min="1" max="20">
                    <select id="diceType">
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10">d10</option>
                        <option value="12">d12</option>
                        <option value="20" selected>d20</option>
                        <option value="100">d100</option>
                    </select>
                    <input type="number" id="diceModifier" placeholder="Mod" value="0" min="-100" max="100">
                </div>
                <button class="action-btn" onclick="rollCustomDice()">ğŸ² Rolar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Token -->
<div class="modal" id="tokenModal">
    <div class="modal-content">
        <h3>Adicionar Token</h3>
        
        <div class="control-group">
            <label>Nome</label>
            <input type="text" id="tokenName" placeholder="Ex: Guerreiro">
        </div>
        
        <div class="control-group">
            <label>Imagem (opcional)</label>
            <input type="file" id="tokenImage" accept="image/*">
        </div>
        
        <div class="modal-actions">
            <button class="btn" onclick="closeTokenModal()">Cancelar</button>
            <button class="action-btn" onclick="createToken()">Criar Token</button>
        </div>
    </div>
</div>

<!-- Modal de PermissÃµes de Tokens -->
<div class="modal" id="tokenPermissionsModal">
    <div class="modal-content" style="max-width: 600px;">
        <h3 id="tokenPermModalTitle">PermissÃµes de Tokens</h3>
        <input type="hidden" id="currentPlayerId">
        
        <p style="color: #bbb; margin-bottom: 15px;">
            Selecione quais tokens este jogador pode mover:
        </p>
        
        <div class="token-perm-list" id="tokenPermList"></div>
        
        <div class="modal-actions">
            <button class="action-btn" onclick="closeTokenPermissionsModal()">Fechar</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script defer src="{{ url_for('static', filename='js/map_manager_enhanced.js') }}"></script>

</body>
</html>