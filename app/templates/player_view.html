<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visualiza√ß√£o do Mapa - Last Take</title>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Lato', sans-serif; background: #0a0a0f; color: #fff; overflow: hidden; }

/* Login Modal */
.login-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.95);
    display: flex; align-items: center; justify-content: center; z-index: 1000;
}
.login-overlay.hidden { display: none; }
.login-box {
    background: linear-gradient(135deg, rgba(26,26,46,0.95), rgba(16,16,30,0.95));
    border: 2px solid #9b59b6; border-radius: 16px; padding: 40px;
    max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(155,89,182,0.3);
}
.login-box h1 { font-family: 'Merriweather', serif; color: #c49bdb; margin-bottom: 10px; text-align: center; }
.login-box p { color: #bbb; text-align: center; margin-bottom: 30px; font-size: 0.9rem; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; color: #bbb; margin-bottom: 8px; font-size: 0.9rem; }
.form-group input {
    width: 100%; padding: 12px 15px; background: rgba(16,16,30,0.8);
    border: 2px solid rgba(155,89,182,0.3); border-radius: 8px;
    color: #fff; font-size: 1rem; transition: border-color 0.3s;
}
.form-group input:focus { outline: none; border-color: #9b59b6; }
.login-btn {
    width: 100%; padding: 12px; background: linear-gradient(135deg, #9b59b6, #8e44ad);
    border: none; border-radius: 8px; color: #fff; font-size: 1rem;
    font-weight: bold; cursor: pointer; transition: transform 0.2s;
}
.login-btn:hover { transform: translateY(-2px); }

/* Header */
.header {
    background: linear-gradient(135deg, rgba(26,26,46,0.95), rgba(16,16,30,0.95));
    border-bottom: 2px solid rgba(155,89,182,0.3); padding: 15px 30px;
    display: flex; justify-content: space-between; align-items: center; z-index: 100;
}
.header h1 { font-family: 'Merriweather', serif; font-size: 1.3rem; color: #c49bdb; }
.header-info { display: flex; gap: 20px; align-items: center; }
.player-name {
    color: #fff; font-weight: bold; padding: 8px 15px;
    background: rgba(155,89,182,0.2); border-radius: 8px;
    border: 1px solid rgba(155,89,182,0.4);
}
.status { padding: 8px 15px; background: rgba(26,26,46,0.9); border: 2px solid rgba(155,89,182,0.3); border-radius: 8px; }
.status-indicator {
    display: inline-block; width: 8px; height: 8px; border-radius: 50%;
    margin-right: 8px; animation: pulse 2s infinite;
}
.status-indicator.connected { background: #2ed573; }
.status-indicator.disconnected { background: #e74c3c; animation: none; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

/* Main Layout */
.main-layout { display: flex; height: calc(100vh - 70px); }

/* Canvas Container */
.canvas-container { flex: 1; position: relative; background: #1a1a2e; overflow: hidden; }
.canvas-wrapper { position: absolute; width: 100%; height: 100%; cursor: grab; }
.canvas-wrapper.grabbing { cursor: grabbing; }
#mapCanvas, #drawingCanvas { position: absolute; image-rendering: crisp-edges; }
#mapCanvas { z-index: 1; }
#drawingCanvas { z-index: 2; pointer-events: none; }

/* Chat Sidebar */
.chat-sidebar {
    width: 350px; background: rgba(26,26,46,0.95);
    border-left: 2px solid rgba(155,89,182,0.3);
    display: flex; flex-direction: column;
}
.chat-header {
    padding: 15px; background: rgba(155,89,182,0.2);
    border-bottom: 2px solid rgba(155,89,182,0.3);
    font-weight: bold; color: #c49bdb;
}
.chat-messages {
    flex: 1; overflow-y: auto; padding: 15px;
    display: flex; flex-direction: column; gap: 10px;
}
.chat-message {
    background: rgba(16,16,30,0.8); border: 1px solid rgba(155,89,182,0.2);
    border-radius: 8px; padding: 10px;
}
.chat-message-header {
    display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85rem;
}
.chat-message-header strong { color: #9b59b6; }
.chat-message-header em { color: #ffc107; font-style: normal; }
.chat-timestamp { color: #666; font-size: 0.75rem; }
.chat-message-text { color: #ddd; font-size: 0.9rem; line-height: 1.4; }
.chat-input-area {
    padding: 15px; background: rgba(16,16,30,0.8);
    border-top: 2px solid rgba(155,89,182,0.3);
}
.chat-recipient-select {
    width: 100%; padding: 10px; margin-bottom: 10px;
    background: rgba(26,26,46,0.9); border: 1px solid rgba(155,89,182,0.3);
    border-radius: 6px; color: #fff; font-size: 0.9rem;
}
.chat-input-row { display: flex; gap: 10px; }
.chat-input {
    flex: 1; padding: 10px; background: rgba(26,26,46,0.9);
    border: 1px solid rgba(155,89,182,0.3); border-radius: 6px;
    color: #fff; font-size: 0.9rem;
}
.chat-send-btn {
    padding: 10px 20px; background: linear-gradient(135deg, #9b59b6, #8e44ad);
    border: none; border-radius: 6px; color: #fff;
    font-weight: bold; cursor: pointer; transition: all 0.3s;
}
.chat-send-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(155,89,182,0.4); }

/* Zoom Controls */
.zoom-controls {
    position: absolute; bottom: 20px; right: 20px;
    display: flex; gap: 10px; z-index: 10;
}
.zoom-btn {
    width: 40px; height: 40px; background: rgba(155,89,182,0.8);
    border: 2px solid #9b59b6; border-radius: 50%; color: #fff;
    font-size: 1.2rem; cursor: pointer; transition: all 0.3s ease;
    display: flex; align-items: center; justify-content: center;
}
.zoom-btn:hover { background: #9b59b6; transform: scale(1.1); }

/* Toast */
.toast {
    position: fixed; top: 90px; right: 30px;
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
    color: #fff; padding: 12px 20px; border-radius: 8px;
    box-shadow: 0 10px 30px rgba(155,89,182,0.5);
    opacity: 0; transform: translateY(-20px);
    transition: all 0.3s ease; z-index: 1000; pointer-events: none;
}
.toast.show { opacity: 1; transform: translateY(0); }

.empty-state { text-align: center; padding: 40px; color: #666; font-style: italic; }

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: rgba(16,16,30,0.5); }
::-webkit-scrollbar-thumb { background: rgba(155,89,182,0.5); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: rgba(155,89,182,0.7); }
</style>
</head>
<body>

<input type="hidden" id="sessionId" value="{{ session_id }}">

<!-- Login Overlay -->
<div class="login-overlay" id="loginOverlay">
    <div class="login-box">
        <h1>üó∫Ô∏è Entrar na Sess√£o</h1>
        <p>Digite seu nome para participar</p>
        
        <div class="form-group">
            <label>Seu Nome:</label>
            <input type="text" id="playerNameInput" placeholder="Ex: Aragorn" maxlength="20" autofocus>
        </div>
        
        <button class="login-btn" id="loginBtn">Entrar na Sess√£o</button>
    </div>
</div>

<!-- Header -->
<header class="header">
    <h1>üó∫Ô∏è Visualiza√ß√£o do Mapa</h1>
    <div class="header-info">
        <div class="player-name" id="playerNameDisplay">Jogador</div>
        <div class="status">
            <span class="status-indicator disconnected" id="statusIndicator"></span>
            <span id="statusText">Conectando...</span>
        </div>
    </div>
</header>

<div class="main-layout">
    <!-- Canvas Container -->
    <div class="canvas-container">
        <div class="canvas-wrapper" id="canvasWrapper">
            <canvas id="mapCanvas"></canvas>
            <canvas id="drawingCanvas"></canvas>
        </div>
        
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoom(-0.1)">‚àí</button>
            <button class="zoom-btn" onclick="zoom(0.1)">+</button>
        </div>
    </div>

    <!-- Chat Sidebar -->
    <div class="chat-sidebar">
        <div class="chat-header">üí¨ Chat</div>
        <div class="chat-messages" id="chatMessages">
            <div class="empty-state">Nenhuma mensagem ainda</div>
        </div>
        <div class="chat-input-area">
            <select class="chat-recipient-select" id="chatRecipient">
                <option value="">Selecione um destinat√°rio</option>
            </select>
            <div class="chat-input-row">
                <input type="text" class="chat-input" id="chatInput" placeholder="Digite sua mensagem..." maxlength="500">
                <button class="chat-send-btn" onclick="sendChatMessage()">Enviar</button>
            </div>
            <p style="color: #888; font-size: 0.75rem; margin-top: 8px; text-align: center;">
                üí° Apenas voc√™ e o destinat√°rio ver√£o mensagens privadas
            </p>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
const socket = io();
const SESSION_ID = document.getElementById('sessionId').value;

let playerName = '';
let playerId = null;
let permissions = { moveTokens: [], draw: false, ping: false };
let allPlayers = [];
let chatMessages = [];

// Canvas
const mapCanvas = document.getElementById('mapCanvas');
const mapCtx = mapCanvas.getContext('2d');
const drawingCanvas = document.getElementById('drawingCanvas');
const drawCtx = drawingCanvas.getContext('2d');
const canvasWrapper = document.getElementById('canvasWrapper');

let w = mapCanvas.width = drawingCanvas.width = 5000;
let h = mapCanvas.height = drawingCanvas.height = 5000;

let maps = [];
let entities = [];
let tokens = [];
let drawings = [];
let currentScale = 1;

let isPanning = false;
let panX = -1500;
let panY = -1500;
let startPanX = 0;
let startPanY = 0;

const TOKEN_RADIUS = 35;
let loadedImages = {};

// ========== LOGIN ==========
document.getElementById('loginBtn').addEventListener('click', () => {
    const nameInput = document.getElementById('playerNameInput');
    const name = nameInput.value.trim();
    
    if (!name) {
        alert('Por favor, digite um nome!');
        return;
    }
    
    playerName = name;
    playerId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    document.getElementById('playerNameDisplay').textContent = playerName;
    document.getElementById('loginOverlay').classList.add('hidden');
    
    socket.emit('player_join', {
        session_id: SESSION_ID,
        player_id: playerId,
        player_name: playerName
    });
    
    showToast(`Bem-vindo, ${playerName}!`);
});

document.getElementById('playerNameInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('loginBtn').click();
});

// ========== WEBSOCKET ==========
socket.on('connect', () => {
    console.log('Conectado');
    updateStatus(true);
});

socket.on('disconnect', () => {
    console.log('Desconectado');
    updateStatus(false);
});

socket.on('session_state', (data) => {
    maps = data.maps || [];
    entities = data.entities || [];
    tokens = data.tokens || [];
    drawings = data.drawings || [];
    preloadAllImages();
});

socket.on('permissions_updated', (data) => {
    if (data.player_id === playerId) {
        permissions = data.permissions;
        showToast('Suas permiss√µes foram atualizadas!');
    }
});

socket.on('maps_sync', (data) => {
    maps = data.maps;
    preloadMapImages();
    redrawAll();
});

socket.on('entities_sync', (data) => {
    entities = data.entities;
    preloadEntityImages();
    redrawAll();
});

socket.on('token_sync', (data) => {
    tokens = data.tokens;
    preloadTokenImages();
    redrawAll();
});

socket.on('drawing_sync', (data) => {
    drawings.push(data.drawing);
    redrawDrawings();
});

socket.on('drawings_cleared', () => {
    drawings = [];
    redrawDrawings();
});

socket.on('players_list', (data) => {
    allPlayers = data.players || [];
    updateChatRecipients();
});

socket.on('player_joined', (data) => {
    showToast(`${data.player_name} entrou na sess√£o`);
});

socket.on('chat_history', (data) => {
    chatMessages = data.messages || [];
    renderChatMessages();
});

socket.on('new_message', (data) => {
    if (!chatMessages.find(m => m.id === data.id)) {
        chatMessages.push(data);
        renderChatMessages();
        playNotificationSound();
    }
});

function updateStatus(connected) {
    const indicator = document.getElementById('statusIndicator');
    const text = document.getElementById('statusText');
    
    if (connected) {
        indicator.className = 'status-indicator connected';
        text.textContent = 'Conectado';
    } else {
        indicator.className = 'status-indicator disconnected';
        text.textContent = 'Desconectado';
    }
}

// ========== IMAGENS ==========
function preloadAllImages() {
    preloadMapImages();
    preloadEntityImages();
    preloadTokenImages();
}

function preloadMapImages() {
    maps.forEach(map => {
        if (map.image && !loadedImages[map.id]) {
            const img = new Image();
            img.onload = () => { loadedImages[map.id] = img; redrawAll(); };
            img.src = map.image;
        }
    });
}

function preloadEntityImages() {
    entities.forEach(entity => {
        if (entity.image && !loadedImages[entity.id]) {
            const img = new Image();
            img.onload = () => { loadedImages[entity.id] = img; redrawAll(); };
            img.src = entity.image;
        }
    });
}

function preloadTokenImages() {
    tokens.forEach(token => {
        if (token.image && !loadedImages[token.id]) {
            const img = new Image();
            img.onload = () => { loadedImages[token.id] = img; redrawAll(); };
            img.src = token.image;
        }
    });
}

// ========== RENDER ==========
function redrawAll() {
    mapCtx.clearRect(0, 0, w, h);
    
    maps.forEach(map => {
        const img = loadedImages[map.id];
        if (img && img.complete) {
            mapCtx.drawImage(img, map.x, map.y, map.width, map.height);
        }
    });
    
    entities.forEach(entity => {
        const img = loadedImages[entity.id];
        if (img && img.complete) {
            mapCtx.drawImage(img, entity.x, entity.y, entity.width, entity.height);
        }
    });
    
    tokens.forEach(token => {
        const img = loadedImages[token.id];
        
        if (img && img.complete) {
            mapCtx.save();
            mapCtx.beginPath();
            mapCtx.arc(token.x, token.y, TOKEN_RADIUS, 0, Math.PI * 2);
            mapCtx.closePath();
            mapCtx.clip();
            mapCtx.drawImage(img, token.x - TOKEN_RADIUS, token.y - TOKEN_RADIUS, TOKEN_RADIUS * 2, TOKEN_RADIUS * 2);
            mapCtx.restore();
        } else if (token.color) {
            mapCtx.fillStyle = token.color;
            mapCtx.beginPath();
            mapCtx.arc(token.x, token.y, TOKEN_RADIUS, 0, Math.PI * 2);
            mapCtx.fill();
        }
        
        mapCtx.strokeStyle = "#fff";
        mapCtx.lineWidth = 2;
        mapCtx.beginPath();
        mapCtx.arc(token.x, token.y, TOKEN_RADIUS, 0, Math.PI * 2);
        mapCtx.stroke();
        
        mapCtx.fillStyle = "#fff";
        mapCtx.font = "bold 13px Lato";
        mapCtx.textAlign = "center";
        mapCtx.strokeStyle = "#000";
        mapCtx.lineWidth = 3;
        mapCtx.strokeText(token.name, token.x, token.y + TOKEN_RADIUS + 18);
        mapCtx.fillText(token.name, token.x, token.y + TOKEN_RADIUS + 18);
    });
}

function redrawDrawings() {
    drawCtx.clearRect(0, 0, w, h);
    
    drawings.forEach(drawing => {
        drawCtx.strokeStyle = drawing.color;
        drawCtx.lineWidth = drawing.size;
        drawCtx.lineCap = 'round';
        drawCtx.lineJoin = 'round';
        
        if (drawing.path.length > 1) {
            drawCtx.beginPath();
            drawCtx.moveTo(drawing.path[0].x, drawing.path[0].y);
            for (let i = 1; i < drawing.path.length; i++) {
                drawCtx.lineTo(drawing.path[i].x, drawing.path[i].y);
            }
            drawCtx.stroke();
        }
    });
}

// ========== PAN/ZOOM ==========
function applyTransform() {
    const transform = `translate(${panX}px, ${panY}px) scale(${currentScale})`;
    canvasWrapper.style.transform = transform;
}

canvasWrapper.addEventListener('mousedown', (e) => {
    isPanning = true;
    startPanX = e.clientX - panX;
    startPanY = e.clientY - panY;
    canvasWrapper.classList.add('grabbing');
});

canvasWrapper.addEventListener('mousemove', (e) => {
    if (isPanning) {
        panX = e.clientX - startPanX;
        panY = e.clientY - startPanY;
        applyTransform();
    }
});

canvasWrapper.addEventListener('mouseup', () => {
    isPanning = false;
    canvasWrapper.classList.remove('grabbing');
});

canvasWrapper.addEventListener('mouseleave', () => {
    isPanning = false;
    canvasWrapper.classList.remove('grabbing');
});

function zoom(delta) {
    currentScale = Math.max(0.3, Math.min(3, currentScale + delta));
    applyTransform();
}

// ========== CHAT ==========
function updateChatRecipients() {
    const select = document.getElementById('chatRecipient');
    select.innerHTML = '';
    
    allPlayers.filter(p => p.id !== playerId).forEach(player => {
        const option = document.createElement('option');
        option.value = player.id;
        option.textContent = `üí¨ ${player.name}`;
        select.appendChild(option);
    });
}

function renderChatMessages() {
    const chatBox = document.getElementById('chatMessages');
    chatBox.innerHTML = '';
    
    if (chatMessages.length === 0) {
        chatBox.innerHTML = '<div class="empty-state">Nenhuma mensagem ainda</div>';
        return;
    }
    
    chatMessages.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message';
        
        const recipientName = msg.recipient_id ? (allPlayers.find(p => p.id === msg.recipient_id)?.name || 'Voc√™') : 'Todos';
        
        msgDiv.innerHTML = `
            <div class="chat-message-header">
                <div>
                    <strong>${msg.sender_name}</strong> 
                    ${msg.recipient_id ? `‚Üí <em>${recipientName}</em>` : ''}
                </div>
                <span class="chat-timestamp">${new Date(msg.timestamp).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</span>
            </div>
            <div class="chat-message-text">${msg.message}</div>
        `;
        
        chatBox.appendChild(msgDiv);
    });
    
    chatBox.scrollTop = chatBox.scrollHeight;
}

function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const recipientSelect = document.getElementById('chatRecipient');
    
    const message = input.value.trim();
    if (!message) return;
    
    const recipientId = recipientSelect.value || null;
    
    socket.emit('send_message', {
        session_id: SESSION_ID,
        sender_id: playerId,
        message: message,
        recipient_id: recipientId
    });
    
    input.value = '';
}

document.getElementById('chatInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendChatMessage();
});

function playNotificationSound() {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGa88OScTgwOWK3n77BdGAg+ltf');
    audio.volume = 0.3;
    audio.play().catch(() => {});
}

// ========== UTILS ==========
function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

applyTransform();
</script>

</body>
</html>